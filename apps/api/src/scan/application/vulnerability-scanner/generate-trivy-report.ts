import { createWriteStream } from 'fs';
import { randomUUID, randomInt } from 'crypto';
import { finished } from 'stream/promises';

const SEVERITIES = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'] as const;

const PKG_NAMES = [
  'express',
  'lodash',
  'axios',
  'body-parser',
  'minimist',
  'qs',
  'debug',
  'semver',
  'tar',
  'glob',
  'jsonwebtoken',
  'moment',
  'underscore',
  'handlebars',
  'marked',
  'mongoose',
  'sequelize',
  'knex',
  'pg',
  'mysql2',
  'ws',
  'socket.io',
  'helmet',
  'cors',
  'cookie-parser',
  'passport',
  'bcrypt',
  'sharp',
  'cheerio',
  'puppeteer',
];

interface GenerateReportArgs {
  outputPath: string;
  criticalCount: number;
  totalCount: number;
}

export async function generateTrivyReport({
  outputPath,
  criticalCount,
  totalCount,
}: GenerateReportArgs): Promise<void> {
  if (criticalCount > totalCount) {
    throw new Error('criticalCount cannot exceed totalCount');
  }

  const stream = createWriteStream(outputPath, { encoding: 'utf-8' });
  const write = (chunk: string) =>
    new Promise<void>((resolve) => {
      if (!stream.write(chunk)) {
        stream.once('drain', resolve);
      } else {
        resolve();
      }
    });

  await write(
    JSON.stringify({
      SchemaVersion: 2,
      Trivy: { Version: '0.69.1' },
      ReportID: randomUUID(),
      CreatedAt: new Date().toISOString(),
      ArtifactID: `sha256:${randomUUID().replace(/-/g, '')}`,
      ArtifactName: '/repo',
      ArtifactType: 'repository',
      Metadata: {
        RepoURL: 'https://github.com/test/repo',
        Branch: 'main',
        Commit: randomUUID().replace(/-/g, ''),
      },
    }).slice(0, -1)
  );

  await write(
    ',"Results":[{"Target":"package-lock.json","Class":"lang-pkgs","Type":"npm","Packages":[],"Vulnerabilities":['
  );

  for (let i = 0; i < totalCount; i++) {
    const isCritical = i < criticalCount;
    const severity = isCritical
      ? 'CRITICAL'
      : SEVERITIES[randomInt(1, SEVERITIES.length)]!;

    const vuln = buildVulnerability(i, severity);

    if (i > 0) await write(',');
    await write(JSON.stringify(vuln));
  }

  await write(']}]}');

  stream.end();
  await finished(stream);
}

function buildVulnerability(index: number, severity: string) {
  const year = randomInt(2019, 2027);
  const seq = randomInt(1000, 99999);
  const vulnId = `CVE-${year}-${seq}`;
  const pkgName = PKG_NAMES[index % PKG_NAMES.length];
  const major = randomInt(0, 10);
  const minor = randomInt(0, 30);
  const patch = randomInt(0, 20);
  const installed = `${major}.${minor}.${patch}`;
  const fixed = `${major}.${minor}.${patch + 1}`;

  return {
    VulnerabilityID: vulnId,
    PkgID: `${pkgName}@${installed}`,
    PkgName: pkgName,
    PkgIdentifier: {
      PURL: `pkg:npm/${pkgName}@${installed}`,
      UID: randomUUID().replace(/-/g, '').slice(0, 16),
    },
    InstalledVersion: installed,
    FixedVersion: fixed,
    Status: 'fixed',
    SeveritySource: 'ghsa',
    PrimaryURL: `https://avd.aquasec.com/nvd/${vulnId.toLowerCase()}`,
    Title: `${pkgName}: ${severity.toLowerCase()} vulnerability in ${pkgName}`,
    Description: `A ${severity.toLowerCase()} severity vulnerability was found in ${pkgName}@${installed}. Upgrading to ${fixed} resolves the issue.`,
    Severity: severity,
    CweIDs: [`CWE-${randomInt(1, 1000)}`],
    References: [
      `https://nvd.nist.gov/vuln/detail/${vulnId}`,
      `https://github.com/advisories/${vulnId}`,
    ],
    PublishedDate: new Date(
      Date.now() - randomInt(0, 365 * 24 * 3600 * 1000)
    ).toISOString(),
    LastModifiedDate: new Date().toISOString(),
  };
}
