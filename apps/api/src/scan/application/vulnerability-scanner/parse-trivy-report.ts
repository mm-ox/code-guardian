import { createReadStream } from 'fs';
import { Writable } from 'stream';
import { pipeline } from 'stream/promises';
import { parser } from 'stream-json';
import { pick } from 'stream-json/filters/Pick';
import { streamArray } from 'stream-json/streamers/StreamArray';
import { Vulnerability } from '../scan.model';

interface TrivyVulnerability {
  VulnerabilityID: string;
  PkgName: string;
  InstalledVersion: string;
  FixedVersion: string;
  Severity: string;
  Title: string;
  Description: string;
}

const CRITICAL_SEVERITY = 'CRITICAL';

export async function parseTrivyReport(
  reportPath: string
): Promise<Vulnerability[]> {
  const vulnerabilities: Vulnerability[] = [];

  await pipeline(
    createReadStream(reportPath),
    parser(),
    pick({ filter: /^Results\.\d+\.Vulnerabilities$/ }),
    streamArray(),
    new Writable({
      objectMode: true,
      write: (chunk: { value: TrivyVulnerability }, _encoding, callback) => {
        if (chunk.value.Severity === CRITICAL_SEVERITY) {
          vulnerabilities.push(mapVulnerability(chunk.value));
        }
        callback();
      },
    })
  );

  return vulnerabilities;
}

function mapVulnerability(vulnerability: TrivyVulnerability): Vulnerability {
  return {
    vulnerabilityId: vulnerability.VulnerabilityID,
    pkgName: vulnerability.PkgName,
    installedVersion: vulnerability.InstalledVersion,
    fixedVersion: vulnerability.FixedVersion || null,
    severity: vulnerability.Severity,
    title: vulnerability.Title || null,
    description: vulnerability.Description || null,
  };
}
