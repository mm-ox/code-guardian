import { writeFileSync, mkdirSync, rmSync } from 'fs';
import { join } from 'path';
import { parseTrivyReport } from './parse-trivy-report';

const FIXTURE_DIR = join(__dirname, '__fixtures__');
const REPORT_PATH = join(FIXTURE_DIR, 'trivy-report.json');

const TRIVY_REPORT = {
  Results: [
    {
      Target: 'package-lock.json',
      Vulnerabilities: [
        {
          VulnerabilityID: 'CVE-2024-0001',
          PkgName: 'lodash',
          InstalledVersion: '4.17.20',
          FixedVersion: '4.17.21',
          Severity: 'CRITICAL',
          Title: 'Prototype Pollution',
          Description: 'Prototype pollution in lodash',
        },
        {
          VulnerabilityID: 'CVE-2024-0002',
          PkgName: 'express',
          InstalledVersion: '4.17.0',
          FixedVersion: '4.18.0',
          Severity: 'HIGH',
          Title: 'Open Redirect',
          Description: 'Open redirect in express',
        },
      ],
    },
    {
      Target: 'yarn.lock',
      Vulnerabilities: [
        {
          VulnerabilityID: 'CVE-2024-0003',
          PkgName: 'minimist',
          InstalledVersion: '0.0.8',
          FixedVersion: '',
          Severity: 'CRITICAL',
          Title: '',
          Description: '',
        },
      ],
    },
  ],
};

beforeAll(() => {
  mkdirSync(FIXTURE_DIR, { recursive: true });
  writeFileSync(REPORT_PATH, JSON.stringify(TRIVY_REPORT));
});

afterAll(() => {
  rmSync(FIXTURE_DIR, { recursive: true, force: true });
});

describe('parseTrivyReport', () => {
  it('should extract only CRITICAL vulnerabilities from all Results', async () => {
    const vulnerabilities = await parseTrivyReport(REPORT_PATH);

    expect(vulnerabilities).toEqual([
      {
        vulnerabilityId: 'CVE-2024-0001',
        pkgName: 'lodash',
        installedVersion: '4.17.20',
        fixedVersion: '4.17.21',
        severity: 'CRITICAL',
        title: 'Prototype Pollution',
        description: 'Prototype pollution in lodash',
      },
      {
        vulnerabilityId: 'CVE-2024-0003',
        pkgName: 'minimist',
        installedVersion: '0.0.8',
        fixedVersion: null,
        severity: 'CRITICAL',
        title: null,
        description: null,
      },
    ]);
  });
});
